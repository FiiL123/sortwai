<!doctype html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.iconify.design/iconify-icon/2.2.0/iconify-icon.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="{% static 'app.css' %}">
    <title>SortWAI</title>
</head>
<body>
    <div id="landing-screen" class="container">
        <div class="flex-container">
            <div class="brand">
                <img src="{% static '/images/recycle-symbol.png' %}" alt="Brand Logo" class="brand_logo" >
                <h1 class="brand_name">SortWAI</h1>
            </div>
        </div>

        <form action="{% url 'query_request' %}" method="POST" class="search" id="query-form">
            {% csrf_token %}
            {% if item %}
                <input type="search" name="q" id="user-input" value="{{ item.product_name }}" class="search__input">
            {% else %}
                <input type="search" name="q" id="user-input" placeholder="Ako triediť...?" class="search__input">
            {% endif %}
            <button class="search__button" type="submit">
                <iconify-icon icon="mdi:search"></iconify-icon>
                <span class="search__button_text">Vyhľadať</span>
            </button>
            <a href="{% url 'scanner' %}" class="search__button">
                <iconify-icon icon="mdi:barcode-scan"></iconify-icon>
                <span class="search__button_text">Čiarový kód</span>
            </a>
        </form>

        <div class="location_note">
            {% if municipality %}
                Zobrazujeme informácie pre <b id="municipality">{{ municipality }}</b> <a id="change_municipality">(zmeniť)</a>
            {% else %}
                Vašu lokáciu sa nepodarilo nájsť, <a class="link" id="change_municipality">vyberte manuálne.</a>
            {% endif %}
        </div>

        <div class="tabs">
            <a href="{% url "category_list" %}" class="tabs__item {% if request.resolver_match.url_name == 'category_list' %}tabs__item--active{% endif %}">
                Odpad
            </a>
            <a href="{% url "location_list" %}" class="tabs__item {% if request.resolver_match.url_name == 'location_list' %}tabs__item--active{% endif %}">
                Miesta
            </a>
            <a href="{% url "document_list" %}" class="tabs__item {% if request.resolver_match.url_name == 'document_list' %}tabs__item--active{% endif %}">
                Dokumenty
            </a>
        </div>

        {% block body %}{% endblock %}
    </div>

    <a href="#" class="chat_cta">
        <iconify-icon icon="mdi:chat-question" width="none"></iconify-icon>
    </a>

    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <form method="POST" action="{% url 'change_municipality' %}">
                {% csrf_token %}
                {{ municipality_form }}
                <button type="submit" class="submit">Zmeň</button>
            </form>
        </div>

    </div>

    <div id="result-screen" class="hidden">
        <button class="back-button">
            <div class="back-button-box">
                <span class="back-button-elem">
                    <svg viewBox="0 0 46 40" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.
                            9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17
                            c.5-.5.8-1.1.8-1.9z"
                        ></path>
                    </svg>
                </span>
                <span class="back-button-elem">
                    <svg viewBox="0 0 46 40">
                        <path
                            d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.
                            9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17
                            c.5-.5.8-1.1.8-1.9z"
                        ></path>
                    </svg>
                </span>
            </div>
        </button>
        <p id="response-text"></p>
    </div>


    <script>
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the button that opens the modal
        var btn = document.getElementById("change_municipality");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
    <script>
        // Handle submission
        document.getElementById("query-form").addEventListener("submit", function (event) {
            event.preventDefault();
            const userQuery = document.getElementById("user-input").value;
            const city = document.getElementById("municipality").innerHTML;
            console.log(userQuery, city);

            const formData = new FormData(this);
            formData.append("city", city);

            console.log("Sending AJAX request...");

            transitionToResult();

            fetch (this.action, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": this.querySelector("[name=csrfmiddlewaretoken]").value,
                },
                body: formData,
            })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Network response was fucked")
                }
                return response.json()
            })
            .then((data) => {
                console.log(JSON.stringify(data.response.bin));
                document.getElementById("response-text").innerText = data.response.bin;
            })
            .catch((error) => {
                console.error("❌ AJAX request failed:", error);
            });
        });

        // Transition to result
        function transitionToResult() {
            document.getElementById("landing-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.add("visible");
        }

        // Handle back button click
        document.querySelector(".back-button").addEventListener("click", function () {
            document.getElementById("landing-screen").classList.remove("hidden");
            const resultScreen = document.getElementById("result-screen");

            resultScreen.classList.add("slide-down");

            setTimeout(() => {
                resultScreen.classList.remove("visible", "slide-down");
            }, 500);
        });
    </script>
    <script src="{% static 'js/location.js' %}"></script>
</body>
</html>
